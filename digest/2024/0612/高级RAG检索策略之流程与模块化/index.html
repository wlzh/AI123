

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#f9f9f9" />

	<title>高级RAG检索策略之流程与模块化 作者： 极客与黑客之路 来源： 极客与黑客之路 我们介绍了很多关于高级 RAG（Retrieval Augmented Generation）的检索策略，每一种策略就像是机器中的零部件，我们可以通过对这些零部件进行不同的组合，来实现不同的 RAG 功能，从而满足不同的需求。今天  | AI123| ai工具网址导航,ai最新产品</title>
	<link rel="shortcut icon" href="/assets/images/favicon.png" />
    <meta name="keywords" content="chatgpt,AI,AI聊天,AI文本生成,AI绘画,AI编程,AI电商" />
    <meta name="description" content="AI123 网址导航 | 免费chatgpt 汇集各类先进的人工智能产品，旨在帮助用户更快速地了解和使用这些产品,轻松地浏览不同领域的AI产品，包括语音识别、图像处理、自然语言处理。" />
    
    <meta name="baidu-site-verification" content="codeva-cCAOSG8MBO" />
    
    <link rel="stylesheet" id="block-library-css"
        href="/assets/css/block-library.min-5.6.2.css" type="text/css" media="all" />
    <link rel="stylesheet" id="iconfont-css" href="/assets/css/iconfont-3.03029.1.css"
        type="text/css" media="all" />

    
    <link href="/scss/style.min.css" rel="stylesheet" />
    
		    <link rel="stylesheet" id="iowen-css" href="/assets/css/style-3.03029.1.css"
        type="text/css" media="all" />
    <link rel="stylesheet" id="custom-css" href="/assets/css/custom-style.css"
        type="text/css" media="all" />
		
		<link rel="stylesheet" href=/plugins/font-awesome/css/font-awesome.min.css />


    <link rel="stylesheet" id="fortawesome-css" href="/assets/fontawesome-5.15.4/css/all.min.css" type="text/css" />


    <script type="text/javascript" src="/assets/js/jquery.min-3.2.1.js" id="jquery-js"></script>
    <script type="text/javascript" src="/assets/js/content-search.js"  id="content-search-js"></script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2073588164294660"
     crossorigin="anonymous"></script>

	
    <script>
        

		var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?8450bc732b2a86f7e4aec4ebd9fd8252";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();

        
    </script>
    

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7071W80M2K"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-7071W80M2K');
    </script>

</head>


    <div class="page-container">
	
	<div id="sidebar" class="sticky sidebar-nav fade animate-nav" style="width: 170px">
        
            <div class="modal-dialog h-100 sidebar-nav-inner">
                <div class="sidebar-logo border-bottom border-color">
                    
                    <div class="logo overflow-hidden">
                        <a href="https://ai123.869hr.uk/" class="logo-expanded">
                            <img src="/assets/images/bt8-expand-light.png" height="40" class="logo-light"
                                alt="AI123| ai工具网址导航,ai最新产品">
                            <img src="/assets/images/bt8-expand-dark.png" height="40" class="logo-dark d-none"
                                alt="AI123| ai工具网址导航,ai最新产品">
                        </a>
                        <a href="https://ai123.869hr.uk/" class="logo-collapsed">
                            <img src="/assets/images/bt.png" height="40" class="logo-light"
                                alt="AI123| ai工具网址导航,ai最新产品">
                            <img src="/assets/images/bt.png" height="40" class="logo-dark d-none"
                                alt="AI123| ai工具网址导航,ai最新产品">
                        </a>
                    </div>
                    
                </div>
                <div class="sidebar-menu flex-fill">
                    <div class="sidebar-scroll">
                        <div class="sidebar-menu-inner">
                            <ul>
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#00834a9dd147b04c5d53d4368cdb0b57" class="smooth">
                                            <i class="fas fa-sun fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>本月热门</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db0311e7ecfedd24d157f0ceb4a0897f" class="smooth">
                                            <i class="fas fa-star-and-crescent fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>热门网站</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#21b5cbb2c769010fec3ce029a5f8a4a3" class="smooth">
                                            <i class="far fa-star fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>国内热门</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#8310718935e8ec25ce0350de01e3f7dc" class="smooth">
                                            <i class="fas fa-phone fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>对话工具</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#d58e850d9115797306c2edf61ac6ddd8" class="smooth">
                                            <i class="fas fa-newspaper fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>写作</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2a7418a5f8f1ca4e054364a9300657df" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>图像生成</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#7808a68ee1b34dab43011429a12de19e" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>图像处理</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#6729afc51f5ac49a828812fa0eb0c82f" class="smooth">
                                            <i class="fas fa-video fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>音视频</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#e5ce844860451fff3faf3d8f8894971d" class="smooth">
                                            <i class="fas fa-music fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>音乐生成</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db53804b7d726967c58fcc8c9ca03d27" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>办公</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#47b7af9547e034d28fe6f6d439968ac8" class="smooth">
                                            <i class="fas fa-copy fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>提示词</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#41282bf95e43c64d579757573a03cdde" class="smooth">
                                            <i class="fas fa-code fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>编程</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#fd71852fd52d5e18ef4f9a252f1eac58" class="smooth">
                                            <i class="fas fa-search fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>AI搜索</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#81b1637fbe47625dbdf2094acd3b6683" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>文本翻译</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2e9ba3fa6e1ed0e9311b3e97f97f9a40" class="smooth">
                                            <i class="fas fa-book fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>学习网站</span>
                                        </a>
                                    </li>
                                    
                                
                            </ul>           
                        </div>
                    </div>
                </div>
                <div class="border-top py-2 border-color">
                    <div class="flex-bottom">
                        <ul>
			    <li id="menu-item-212"
                                 class="menu-item menu-item-type-custom menu-item-object-custom menu-item-212 sidebar-item">
                                 <a href="#friendlink" class="smooth">
                                     <i class="fab fa-staylinked icon-fw icon-lg mr-2"></i>
                                     <span>友情链接</span>
                                 </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div class="flex-fill grid-bg">
    <div class="big-header-banner">
        <div id="header" class="page-header sticky">
            <div class="navbar navbar-expand-md">
                <div class="container-fluid p-0">

                    <a href="" class="navbar-brand d-md-none" title="AI123| ai工具网址导航,ai最新产品">
                        <img src="/assets/images/bt.png" class="logo-light"
                            alt="AI123| ai工具网址导航,ai最新产品">
                        <img src="/assets/images/bt.png" class="logo-dark d-none"
                            alt="AI123| ai工具网址导航,ai最新产品">
                    </a>

                    <div class="collapse navbar-collapse order-2 order-md-1">
                        <div class="header-mini-btn">
                            <label>
                                <input id="mini-button" type="checkbox">
                                <svg viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                    <path class="line--1" d="M0 40h62c18 0 18-20-17 5L31 55"></path>
                                    <path class="line--2" d="M0 50h80"></path>
                                    <path class="line--3" d="M0 60h62c18 0 18 20-17-5L31 45"></path>
                                </svg>
                            </label>

                        </div>

                        <ul class="navbar-nav site-menu" style="margin-right: 16px;">
                        
			<li >
				<a href="/">
                                    <i class="fa fa-home fa-lg mr-2"></i>
                                    <span>首页</span>
                                </a>
				<ul class="sub-menu">
				
				</ul>
			    </li>
			
			</ul>

                        
                        <div class="rounded-circle weather">
                            <div id="he-plugin-simple" style="display: contents;"></div>
                            <script>WIDGET = {
                                    CONFIG: {
                                        "modules": "01234",
                                        "background": 5,
                                        "tmpColor": "008000",
                                        "tmpSize": 14,
                                        "cityColor": "008000",
                                        "citySize": 14,
                                        "aqiColor": "#008000",
                                        "aqiSize": 14,
                                        "weatherIconSize": 24,
                                        "alertIconSize": 18,
                                        "padding": "10px 10px 10px 10px",
                                        "shadow": "1",
                                        "language": "auto",
                                        "borderRadius": 5,
                                        "fixed": "false",
                                        "vertical": "middle",
                                        "horizontal": "left",
                                        "key": "085791e805a24491b43b06cf58ab31e7"
                                    }
                                }
                            </script>
                            <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script>
                        </div>
                        
                    </div>

                    <ul class="nav navbar-menu text-xs order-1 order-md-2">
                        
                        
                        <li class="nav-item mr-3 mr-lg-0 d-none d-lg-block">
                            <script>
                                fetch('https://v1.hitokoto.cn')
                                    .then(response => response.json())
                                    .then(data => {
                                    const hitokoto = document.getElementById('hitokoto_text')
                                    hitokoto.href = 'https://hitokoto.cn/?uuid=' + data.uuid
                                    hitokoto.innerText = data.hitokoto
                                    })
                                    .catch(console.error)
                            </script>                           
                            <div id="hitokoto"><a href="#" target="_blank" id="hitokoto_text">疏影横斜水清浅，暗香浮动月黄昏。</a></div>
                        </li>
                        
                        
                        <li class="nav-search ml-3 ml-md-4">
                            <a href="javascript:" data-toggle="modal" data-target="#search-modal"><i
                                    class="iconfont icon-search icon-2x"></i></a>
                        </li>
                        <li class="nav-item d-md-none mobile-menu ml-3 ml-md-4">
                            <a href="javascript:" id="sidebar-switch" data-toggle="modal"
                                data-target="#sidebar"><i class="iconfont icon-classification icon-2x"></i></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="placeholder" style="height:74px"></div>
    </div>




<body class="page-body boxed-container  io-grey-mode">
    <main role="main" class="flex-shrink-0">
    <div class="container">
        
        <div class="content">
            <style>
    body{
	    background: #f9f9f9;
	}

    h1, h2, h3, h4, h5, h6 {
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
    }


 
@media (min-width: 1000px) {
  .container, .container-sm {
    max-width: 800px;
  }
}

</style>

<div class="featured-post-content">

    <a href="/digest/" class="featured-post-title">
       AI 文摘
    </a>

</div>

<section class="blog-single">
  <div class="container">
    <div class="row">

      <div class="col-lg-12 order-1 order-lg-2">
        <article class="single-blog">
          <p class="title">高级RAG检索策略之流程与模块化</p>
            <br/>
          <ul class="meta">
            <li>
              By <a href=https://ai123.869hr.uk/about>AI123</a>
            </li>
            <li>
              <i class="fa fa-clock-o"></i>
              June 12, 2024 - 2 min read
            </li>
          </ul>

          <div class="_1NCGf">
              <img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/adswRFDIWz0yt8hpZYRE2yMvDX5VKicdHIxBBkpcMoBnvjJJT6xCBZ10r2DoqxZnT1RDOdicP1XHcTLkz0qnH8ZA/640?wx_fmt=png" width="640" >
          </div>
            <br>
            <br>
            <br>
          
          <div class="single-blog-content">
            <p>作者： 极客与黑客之路  来源： <a href="https://mp.weixin.qq.com/s/WeAcAevUPemPKhQLhId3Vg">极客与黑客之路</a></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_jpg/adswRFDIWz0yt8hpZYRE2yMvDX5VKicdHtnIeLEOWyiaJib6CKiaQfc8GNNwpobhJ2orTCHS3VyYztz22KvcgTm0aA/640?wx_fmt=jpeg" alt=""></p>
<p>我们介绍了很多关于高级 RAG（Retrieval Augmented Generation）的检索策略，每一种策略就像是机器中的零部件，我们可以通过对这些零部件进行不同的组合，来实现不同的 RAG 功能，从而满足不同的需求。今天我们就来介绍高级 RAG 检索中一些常见的 RAG 模块，以及如何通过流程的方式来组合这些模块，实现高级 RAG 检索功能。</p>
<h4 id="rag-模块化">RAG 模块化</h4>
<p>模块化 RAG 提出了一种高度可扩展的范例，将 RAG 系统分为模块类型、模块和操作符的三层结构。每个模块类型代表 RAG 系统中的一个核心流程，包含多个功能模块。每个功能模块又包含多个特定的操作符。整个 RAG 系统变成了多个模块和相应操作符的排列组合，形成了我们所说的 RAG 流程。在流程中，每种模块类型可以选择不同的功能模块，并且在每个功能模块中可以选择一个或多个操作符。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_jpg/adswRFDIWz0yt8hpZYRE2yMvDX5VKicdHvl4JdJUXjGAGtgCWEKvOjKytONMux6dfblGK3hAuEJ0w7fr8US6Wzg/640?wx_fmt=jpeg" alt=""></p>
<h4 id="rag-流程">RAG 流程</h4>
<p>RAG 流程是指在 RAG 系统中，从输入查询到输出生成文本的整个工作流程。这个流程通常涉及多个模块和操作符的协同工作，包括但不限于检索器、生成器以及可能的预处理和后处理模块。RAG 流程的设计旨在使得 LLM（大语言模型）能够在生成文本时利用外部知识库或文档集，从而提高回答的准确性和相关性。</p>
<p>RAG 推理阶段的流程一般分为以下几种模式：</p>
<ul>
<li>
<p>Sequential: 线性流程，包括高级和简单的 RAG 范式</p>
</li>
<li>
<p>Conditional: 基于查询的关键词或语义选择不同的 RAG 路径</p>
</li>
<li>
<p>Branching: 包括多个并行分支，分为预检索和后检索的分支结构</p>
</li>
<li>
<p>Loop: 包括迭代、递归和自适应检索等多种循环结构</p>
</li>
</ul>
<p>下图是 Loop 模式的 RAG 流程图：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_jpg/adswRFDIWz0yt8hpZYRE2yMvDX5VKicdH20twxaoA4egZ34GurrfdphBlLTpEJSeDn1ibHGOLIrWgMtw5EZJr8dA/640?wx_fmt=jpeg" alt=""></p>
<p>后面我们主要以 Sequential 模式为例，介绍如何通过模块化和流水线的方式来实现高级 RAG 检索功能。</p>
<h4 id="代码示例">代码示例</h4>
<p>LlamaIndex[1]的查询流水线（Query Pipeline）功能提供了一种模块化的方式来组合 RAG 检索策略。我们可以通过定义不同的模块，然后将这些模块按照一定的顺序组合起来，形成一个完整的查询流水线。下面我们通过一个从简单到复杂的示例来演示如何使用 LlamaIndex 的查询流水线功能实现高级 RAG 检索。</p>
<h4 id="普通-rag">普通 RAG</h4>
<p>首先我们定义一个普通 RAG 的流水线，这个流水线包含了 3 个模块，分别是：输入、检索和输出。其中输入模块用于接收用户输入的查询，检索模块用于从知识库中检索相关文档，输出模块用于根据检索结果生成回答。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/adswRFDIWz0yt8hpZYRE2yMvDX5VKicdHp93wB5eCkRricwyzlf3TziasAp0piblgHeDHbibdfgt6YZemY3AOaPBlAA/640?wx_fmt=png" alt=""></p>
<p>在定义查询流水线之前，我们先将我们的测试文档索引入库，这里的测试文档还是用维基百科上的复仇者联盟[2]电影剧情，示例代码如下：</p>
<pre><code>import os  
from llama_index.llms.openai import OpenAI  
from llama_index.embeddings.openai import OpenAIEmbedding  
from llama_index.core import (  
    Settings,  
    SimpleDirectoryReader,  
    StorageContext,  
    VectorStoreIndex,  
    load_index_from_storage,  
)  
from llama_index.core.node_parser import SentenceSplitter  
  
documents = SimpleDirectoryReader(&quot;./data&quot;).load_data()  
node_parser = SentenceSplitter()  
llm = OpenAI(model=&quot;gpt-3.5-turbo&quot;)  
embed_model = OpenAIEmbedding(model=&quot;text-embedding-3-small&quot;)  
Settings.llm = llm  
Settings.embed_model = embed_model  
Settings.node_parser = node_parser  
  
if not os.path.exists(&quot;storage&quot;):  
    index = VectorStoreIndex.from_documents(documents)  
    index.set_index_id(&quot;avengers&quot;)  
    index.storage_context.persist(&quot;./storage&quot;)  
else:  
    store_context = StorageContext.from_defaults(persist_dir=&quot;./storage&quot;)  
    index = load_index_from_storage(  
        storage_context=store_context, index_id=&quot;avengers&quot;  
    )  
</code></pre>
<ul>
<li>
<p>首先我们通过SimpleDirectoryReader
读取./data
目录下的文档</p>
</li>
<li>
<p>然后我们定义了一个SentenceSplitter
用于将文档进行分割</p>
</li>
<li>
<p>接着我们使用OpenAI
的 LLM 和 Embedding 模型来生成文本和向量，并将他们添加到Settings
中</p>
</li>
<li>
<p>最后我们将文档索引入库，并将索引保存到./storage
目录下，以便后续使用</p>
</li>
</ul>
<p>接下来我们定义一个普通的 RAG 流水线，示例代码如下：</p>
<pre><code>from llama_index.core.query_pipeline import QueryPipeline, InputComponent  
from llama_index.core.response_synthesizers.simple_summarize import SimpleSummarize  
  
retriever =  index.as_retriever()  
p = QueryPipeline(verbose=True)  
p.add_modules(  
    {  
        &quot;input&quot;: InputComponent(),  
        &quot;retriever&quot;: retriever,  
        &quot;output&quot;: SimpleSummarize(),  
    }  
)  
  
p.add_link(&quot;input&quot;, &quot;retriever&quot;)  
p.add_link(&quot;input&quot;, &quot;output&quot;, dest_key=&quot;query_str&quot;)  
p.add_link(&quot;retriever&quot;, &quot;output&quot;, dest_key=&quot;nodes&quot;)  
</code></pre>
<ul>
<li>
<p>我们创建了一个普通检索器retriever
，用于从知识库中检索相关文档</p>
</li>
<li>
<p>然后创建了一个QueryPipeline
对象，这是查询流水线的主体，设置 verbose 参数为 True
用于输出详细信息</p>
</li>
<li>
<p>通过QueryPipeline
的add_modules
方法添加了 3 个模块：input、retriever和output</p>
</li>
<li>
<p>input模块的实现类是InputComponent
，这是查询流水线常用的输入组件，retriever模块是我们定义的检索器，output模块的实现类是SimpleSummarize
，这是可以将问题和检索结果进行简单总结的输出组件</p>
</li>
<li>
<p>接着我们添加模块间的连接关系，add_link
方法用于连接模块之间的关系，第一个参数是源模块，第二个参数是目标模块</p>
</li>
<li>
<p>dest_key
参数用于指定目标模块的输入参数，因为输出模块有 2 个参数，分别是问题和检索结果，所以我们需要指定dest_key
参数，当目标模块只有一个参数时则不需要指定</p>
</li>
<li>
<p>在add_link
方法中，与dest_key 参数
对应的是src_key 参数
，当源模块有多个参数时，我们需要指定src_key
参数，反之则不需要。</p>
</li>
</ul>
<p>查询流水线添加模块和连接关系的方式除了add_modules
和add_link
方法外，还可以通过add_chain
方法添加，示例代码如下：</p>
<pre><code>p = QueryPipeline(verbose=True)  
p.add_chain([InputComponent(), retriever])  
</code></pre>
<p>这种方式可以一次性添加模块与连接关系，但这种方式只能添加单参数的模块，如果模块有多个参数则需要使用add_modules
和add_link
方法。</p>
<p>接下来我们再来运行查询流水线，示例代码如下：</p>
<pre><code>question = &quot;Which two members of the Avengers created Ultron?&quot;  
output = p.run(input=question)  
print(str(output))  
  
# 结果显示  
&gt; Running module input with input:  
input: Which two members of the Avengers created Ultron?  
  
&gt; Running module retriever with input:  
input: Which two members of the Avengers created Ultron?  
  
&gt; Running module output with input:  
query_str: Which two members of the Avengers created Ultron?  
nodes: [NodeWithScore(node=TextNode(id_='53d32f3a-a2d5-47b1-aa8f-a9679e83e0b0', embedding=None, metadata={'file_path': '/data/Avengers:Age-of-Ul...  
  
Bruce Banner and Tony Stark.  
</code></pre>
<ul>
<li>
<p>使用查询流水线的run
方法运行查询流水线，传入问题作为输入参数</p>
</li>
<li>
<p>在显示结果中可以看到查询流水线的调试信息，查询流水线首先运行了input模块，然后运行了retriever模块，最后运行了output模块，调试信息还打印了每个模块的输入参数，最后输出了问题的答案</p>
</li>
</ul>
<h4 id="增加-reranker-模块">增加 reranker 模块</h4>
<p>接下来我们在普通 RAG 的基础上增加一个 reranker 模块，用于对检索结果进行重新排序。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/adswRFDIWz0yt8hpZYRE2yMvDX5VKicdHTsVNb9cSRZkHCKQ55I7Hyklicu7muJgUNVP0f1K3tJQyA9Gh3jMvNBQ/640?wx_fmt=png" alt=""></p>
<pre><code>+from llama_index.postprocessor.cohere_rerank import CohereRerank  
  
+reranker = CohereRerank()  
p = QueryPipeline(verbose=True)  
p.add_modules(  
    {  
        &quot;input&quot;: InputComponent(),  
        &quot;retriever&quot;: retriever,  
+        &quot;reranker&quot;: reranker,  
        &quot;output&quot;: SimpleSummarize(),  
    }  
)  
  
p.add_link(&quot;input&quot;, &quot;retriever&quot;)  
+p.add_link(&quot;input&quot;, &quot;reranker&quot;, dest_key=&quot;query_str&quot;)  
+p.add_link(&quot;retriever&quot;, &quot;reranker&quot;, dest_key=&quot;nodes&quot;)  
p.add_link(&quot;input&quot;, &quot;output&quot;, dest_key=&quot;query_str&quot;)  
-p.add_link(&quot;retriever&quot;, &quot;output&quot;, dest_key=&quot;nodes&quot;)  
+p.add_link(&quot;reranker&quot;, &quot;output&quot;, dest_key=&quot;nodes&quot;)  
</code></pre>
<ul>
<li>
<p>这里我们使用了Cohere[3]公司的 rerank 功能，在 LlamaIndex 中提供了CohereRerank
类用于实现 Cohere 的 rerank 功能</p>
</li>
<li>
<p>要使用CohererRerank
类，需要先在 Cohere 官网上注册账号并获取 API KEY，并在环境变量中设置COHERE_API_KEY
的值：export COHERE_API_KEY=your-cohere-api-key</p>
</li>
<li>
<p>然后我们在查询流水线中添加一个reranker
模块，并将其添加到retriever模块和output模块之间，用于对检索结果进行重新排序</p>
</li>
<li>
<p>我们去除原来从retriever
模块到output
模块的连接关系，增加了retriever
模块到reranker
模块和reranker
模块到output
模块的连接关系</p>
</li>
<li>
<p>reranker
模块同样需要 2 个参数，分别是问题和检索结果，这样reranker
模块才可以根据问题对检索结果进行重新排序，所以我们需要指定dest_key
参数</p>
</li>
</ul>
<p>查询流水线的运行方法除了run
方法外，还有run_with_intermeation
方法，这个方法可以获取流水线的中间结果，我们将retriever
和rerank
模块的中间结果打印出来进行对比，示例代码如下：</p>
<pre><code>output, intermediates = p.run_with_intermediates(input=question)  
retriever_output = intermediates[&quot;retriever&quot;].outputs[&quot;output&quot;]  
print(f&quot;retriever output:&quot;)  
for node in retriever_output:  
    print(f&quot;node id: {node.node_id}, node score: {node.score}&quot;)  
reranker_output = intermediates[&quot;reranker&quot;].outputs[&quot;nodes&quot;]  
print(f&quot;\nreranker output:&quot;)  
for node in reranker_output:  
      print(f&quot;node id: {node.node_id}, node score: {node.score}&quot;)  
  
# 显示结果  
retriever output:  
node id: 53d32f3a-a2d5-47b1-aa8f-a9679e83e0b0, node score: 0.6608391314791646  
node id: dea3844b-789f-46de-a415-df1ef14dda18, node score: 0.5313643379538727  
  
reranker output:  
node id: 53d32f3a-a2d5-47b1-aa8f-a9679e83e0b0, node score: 0.9588471  
node id: dea3844b-789f-46de-a415-df1ef14dda18, node score: 0.5837967  
</code></pre>
<ul>
<li>
<p>执行run_with_intermediates
方法后返回结果是一个元组，包含了输出结果和中间结果</p>
</li>
<li>
<p>要获取某个模块的中间结果，可以通过intermediates
变量加上模块 key 进行获取，比如intermediates[&ldquo;retriever&rdquo;]
是获取检索模块的中间结果</p>
</li>
<li>
<p>每个中间结果都有 2 个参数，分别是inputs
和outputs
，inputs
表示模块的输入参数，outputs
表示模块的输出参数</p>
</li>
<li>
<p>inputs
和outputs
参数类型是字典，比如reranker
模块的outputs
参数中包含了nodes
属性，我们可以这样来获取nodes
属性的值：intermediates[&ldquo;reranker&rdquo;].outputs[&ldquo;nodes&rdquo;]</p>
</li>
</ul>
<h4 id="增加-query-rewrite-模块">增加 query rewrite 模块</h4>
<p>之前我们在查询流水线中加入了 reranker 模块，相当是对检索结果的后处理
操作，现在我们再加入一个 query rewrite 模块，用于对查询问题进行预处理
操作。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/adswRFDIWz0yt8hpZYRE2yMvDX5VKicdHIxBBkpcMoBnvjJJT6xCBZ10r2DoqxZnT1RDOdicP1XHcTLkz0qnH8ZA/640?wx_fmt=png" alt=""></p>
<pre><code>+query_rewriter = HydeComponent()  
p = QueryPipeline(verbose=True)  
p.add_modules(  
    {  
        &quot;input&quot;: InputComponent(),  
+        &quot;query_rewriter&quot;: query_rewriter,  
        &quot;retriever&quot;: retriever,  
        &quot;reranker&quot;: reranker,  
        &quot;output&quot;: SimpleSummarize(),  
    }  
)  
  
-p.add_link(&quot;input&quot;, &quot;retriever&quot;)  
+p.add_link(&quot;input&quot;, &quot;query_rewriter&quot;)  
+p.add_link(&quot;query_rewriter&quot;, &quot;retriever&quot;)  
p.add_link(&quot;input&quot;, &quot;reranker&quot;, dest_key=&quot;query_str&quot;)  
p.add_link(&quot;retriever&quot;, &quot;reranker&quot;, dest_key=&quot;nodes&quot;)  
p.add_link(&quot;input&quot;, &quot;output&quot;, dest_key=&quot;query_str&quot;)  
p.add_link(&quot;reranker&quot;, &quot;output&quot;, dest_key=&quot;nodes&quot;)  
</code></pre>
<ul>
<li>
<p>这里我们定义了一个HydeComponent
类用于实现查询重写的功能，使用的是 HyDE（假设性文档向量）查询重写策略，它会根据查询问题生成一个假设性回答，然后使用这个假设性回答去检索文档，从而提高检索的准确性</p>
</li>
<li>
<p>HydeComponent
是一个自定义的查询流水线组件，后面我们再详细介绍它的实现</p>
</li>
<li>
<p>我们在原有的查询流水线上增加了一个query_rewriter
模块，放在input模块和retriever模块之间，用于对查询问题进行预处理</p>
</li>
<li>
<p>我们去除原来从input
模块到retriever
模块的连接关系，增加了input
模块到query_rewriter
模块和query_rewriter
模块到retriever
模块的连接关系</p>
</li>
<li>
<p>query_rewriter
模块只有一个参数，所以不需要指定dest_key
参数</p>
</li>
</ul>
<p>LlamaIndex 的查询流水线提供了自定义组件的功能，我们可以通过继承CustomQueryComponent
类来实现自定义组件，下面我们来实现HydeComponent
类，示例代码如下：</p>
<pre><code>from llama_index.core.query_pipeline import CustomQueryComponent  
from typing import Dict, Any  
from llama_index.core.indices.query.query_transform import HyDEQueryTransform  
  
class HydeComponent(CustomQueryComponent):  
    &quot;&quot;&quot;HyDE query rewrite component.&quot;&quot;&quot;  
  
    def _validate_component_inputs(self, input: Dict[str, Any]) -&gt; Dict[str, Any]:  
        &quot;&quot;&quot;Validate component inputs during run_component.&quot;&quot;&quot;  
        assert &quot;input&quot; in input, &quot;input is required&quot;  
        return input  
  
    @property  
    def _input_keys(self) -&gt; set:  
        &quot;&quot;&quot;Input keys dict.&quot;&quot;&quot;  
        return {&quot;input&quot;}  
  
    @property  
    def _output_keys(self) -&gt; set:  
        return {&quot;output&quot;}  
  
    def _run_component(self,**kwargs) -&gt; Dict[str, Any]:  
        &quot;&quot;&quot;Run the component.&quot;&quot;&quot;  
        hyde = HyDEQueryTransform(include_original=True)  
        query_bundle = hyde(kwargs[&quot;input&quot;])  
        return {&quot;output&quot;: query_bundle.embedding_strs[0]}  
</code></pre>
<ul>
<li>
<p>HydeComponent
类中的_validate_component_inputs
方法用于验证组件的输入参数，必须实现这个方法，否则会抛出异常</p>
</li>
<li>
<p>_input_keys
和_output_keys
属性分别用于定义组件的输入和输出 key 值</p>
</li>
<li>
<p>_run_component
方法用于实现组件的具体功能，这里我们使用HyDEQueryTransform
类实现了 HyDE 查询重写功能，将查询问题转换为假设性回答，并返回这个假设性回答</p>
</li>
</ul>
<p>关于查询重写的更多策略，可以参考我之前的<a href="http://mp.weixin.qq.com/s?__biz=Mzg5NDkxMzQwMA==&amp;mid=2247484194&amp;idx=1&amp;sn=8d41c966363b6d056d58694519d1dee2&amp;chksm=c0191d35f76e9423882800bfccf3653f042f209e0bc956cb91e1e70a139ae6514843432b8093&amp;scene=21#wechat_redirect">这篇文章</a>。</p>
<h4 id="替换-output-模块">替换 output 模块</h4>
<p>在之前的查询流水线中，我们使用的是简单的总结输出组件，现在我们将其替换为树形总结组件，用来提高最终的输出结果。</p>
<blockquote>
<p><strong>树形总结</strong> 组件以自底向上的方式递归地合并文本块并对其进行总结（即从叶子到根构建一棵树）。 具体地说，在每个递归步骤中：</p>
<ol>
<li>
<p>我们重新打包文本块，使得每个块填充大语言模型的上下文窗口</p>
</li>
<li>
<p>如果只有一个块，我们给出最终响应</p>
</li>
<li>
<p>否则，我们总结每个块，并递归地总结这些摘要</p>
</li>
</ol>
</blockquote>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/adswRFDIWz0yt8hpZYRE2yMvDX5VKicdHPibScwZBdTxbmsvn9xhkEEH6fr0POzwNdc1Ko12yOyBvYLgdPQOX4Dw/640?wx_fmt=png" alt=""></p>
<pre><code>+from llama_index.core.response_synthesizers.tree_summarize import TreeSummarize  
  
p = QueryPipeline(verbose=True)  
p.add_modules(  
    {  
        &quot;input&quot;: InputComponent(),  
        &quot;query_rewriter&quot;: query_rewriter,  
        &quot;retriever&quot;: retriever,  
        &quot;reranker&quot;: reranker,  
-        &quot;output&quot;: SimpleSummarize(),  
+        &quot;output&quot;: TreeSummarize(),  
    }  
)  
</code></pre>
<ul>
<li>
<p>替换output
模块的组件比较简单，只需要将原来的SimpleSummarize
替换为TreeSummarize
即可</p>
</li>
<li>
<p>TreeSummarize
组件的结构和SimpleSummarize
组件类似，因此这里我们不需要修改其他模块的连接关系</p>
</li>
</ul>
<p>查询流水线实际上是一个 DAG（有向无环图），每个模块是图中的一个节点，模块之间的连接关系是图中的边，我们可以通过代码来展示这个图形结构，示例代码如下：</p>
<pre><code>from pyvis.network import Network  
  
net = Network(notebook=True, cdn_resources=&quot;in_line&quot;, directed=True)  
net.from_nx(p.clean_dag)  
net.write_html(&quot;output/pipeline_dag.html&quot;)  
</code></pre>
<ul>
<li>
<p>我们使用pyvis
库来绘制查询流水线的图形结构</p>
</li>
<li>
<p>Network
类用于创建一个网络对象，notebook=True
表示在 Jupyter Notebook 中显示，cdn_resources=&ldquo;in_line&rdquo;
表示使用内联资源，directed=True
表示有向图</p>
</li>
<li>
<p>from_nx
方法用于将查询流水线的 DAG 结构转换为网络对象</p>
</li>
<li>
<p>write_html
方法用于将网络对象保存为 HTML 文件，这样我们就可以在浏览器中查看查询流水线的图形结构</p>
</li>
</ul>
<p>保存后的查询流水线图形结构如下：</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/adswRFDIWz0yt8hpZYRE2yMvDX5VKicdHvKMc4pcvBYYMy8h18AzQDKkpF4lgps0UmPEwIbiaDSvia9vxhuyy1RbA/640?wx_fmt=png" alt=""></p>
<h4 id="使用句子窗口检索">使用句子窗口检索</h4>
<p>在之前的查询流水线中，retriever模块使用的是普通的检索策略，现在我们将其替换为句子窗口检索策略，用于提高检索的准确性。</p>
<blockquote>
<p>句子窗口检索的原理：首先在文档切分时，将文档以句子为单位进行切分，同时进行 Embedding 并保存数据库。然后在检索时，通过问题检索到相关的句子，但并不只是将检索到的句子作为检索结果，而是将该句子前面和后面的句子一起作为检索结果，包含的句子数量可以通过参数来进行设置，最后将检索结果再一起提交给 LLM 来生成答案。</p>
</blockquote>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/adswRFDIWz0yt8hpZYRE2yMvDX5VKicdH3xnrJOQMe8lia7semnPxhBBcILQ7FfaqHOVXhHibVvGIK6ee6lT1VhFQ/640?wx_fmt=png" alt=""></p>
<pre><code>+from llama_index.core.node_parser import SentenceWindowNodeParser  
  
-node_parser = SentenceSplitter()  
+node_parser = SentenceWindowNodeParser.from_defaults(  
+    window_size=3,  
+    window_metadata_key=&quot;window&quot;,  
+    original_text_metadata_key=&quot;original_text&quot;,  
+)  
  
+meta_replacer = MetadataReplacementPostProcessor(target_metadata_key=&quot;window&quot;)  
p = QueryPipeline(verbose=True)  
p.add_modules(  
    {  
        &quot;input&quot;: InputComponent(),  
        &quot;query_rewriter&quot;: query_rewriter,  
        &quot;retriever&quot;: retriever,  
+        &quot;meta_replacer&quot;: meta_replacer,  
        &quot;reranker&quot;: reranker,  
        &quot;output&quot;: TreeSummarize(),  
    }  
)  
p.add_link(&quot;input&quot;, &quot;query_rewriter&quot;)  
p.add_link(&quot;query_rewriter&quot;, &quot;retriever&quot;)  
+p.add_link(&quot;retriever&quot;, &quot;meta_replacer&quot;)  
p.add_link(&quot;input&quot;, &quot;reranker&quot;, dest_key=&quot;query_str&quot;)  
-p.add_link(&quot;retriever&quot;, &quot;reranker&quot;, dest_key=&quot;nodes&quot;)  
+p.add_link(&quot;meta_replacer&quot;, &quot;reranker&quot;, dest_key=&quot;nodes&quot;)  
p.add_link(&quot;input&quot;, &quot;output&quot;, dest_key=&quot;query_str&quot;)  
p.add_link(&quot;reranker&quot;, &quot;output&quot;, dest_key=&quot;nodes&quot;)  
</code></pre>
<ul>
<li>
<p>句子窗口检索首先需要调整文档的入库策略，以前是用SentenceSplitter
来切分文档，现在我们使用SentenceWindowNodeParser
来切分文档，窗口大小为 3，原始文本的 key 为original_text
，窗口文本的 key 为window</p>
</li>
<li>
<p>句子窗口检索的原理是在检索出结果后，将检索到的节点文本替换成窗口文本，所以这里需要增加一个meta_replacer
模块，用来替换检索结果中的节点文本</p>
</li>
<li>
<p>meta_replacer
模块的实现类是MetadataReplacementPostProcessor
，输入参数是检索结果nodes
，输出结果是替换了节点文本的检索结果nodes</p>
</li>
<li>
<p>我们将meta_replacer
模块放在retriever
模块和reranker
模块之间，先对检索结果进行元数据替换处理，然后再进行 rerank 操作，因此这里修改了这 3 个模块的连接关系</p>
</li>
</ul>
<p>我们可以打印出retriever
模块和meta_replacer
模块的中间结果，来对比检索结果的变化，示例代码如下：</p>
<pre><code>output, intermediates = p.run_with_intermediates(input=question)  
retriever_output = intermediates[&quot;retriever&quot;].outputs[&quot;output&quot;]  
print(f&quot;retriever output:&quot;)  
for node in retriever_output:  
    print(f&quot;node: {node.text}\n&quot;)  
meta_replacer_output = intermediates[&quot;meta_replacer&quot;].outputs[&quot;nodes&quot;]  
print(f&quot;meta_replacer output:&quot;)  
for node in meta_replacer_output:  
    print(f&quot;node: {node.text}\n&quot;)  
  
# 显示结果  
retriever output:  
node: In the Eastern European country of Sokovia, the Avengers—Tony Stark, Thor, Bruce Banner, Steve Rogers, Natasha Romanoff, and Clint Barton—raid a Hydra facility commanded by Baron Wolfgang von Strucker, who has experimented on humans using the scepter previously wielded by Loki.  
  
node: They meet two of Strucker's test subjects—twins Pietro (who has superhuman speed) and Wanda Maximoff (who has telepathic and telekinetic abilities)—and apprehend Strucker, while Stark retrieves Loki's scepter.  
  
meta_replacer output:  
node: and attacks the Avengers at their headquarters.  Escaping with the scepter, Ultron uses the resources in Strucker's Sokovia base to upgrade his rudimentary body and build an army of robot drones.  Having killed Strucker, he recruits the Maximoffs, who hold Stark responsible for their parents' deaths by his company's weapons, and goes to the base of arms dealer Ulysses Klaue in Johannesburg to get vibranium.  The Avengers attack Ultron and the Maximoffs, but Wanda subdues them with haunting visions, causing Banner to turn into the Hulk and rampage until Stark stops him with his anti-Hulk armor. [a]  
A worldwide backlash over the resulting destruction, and the fears Wanda's hallucinations incited, send the team into hiding at Barton's farmhouse.  Thor departs to consult with Dr.  Erik Selvig on the apocalyptic future he saw in his hallucination, while Nick Fury arrives and encourages the team to form a plan to stop Ultron.  
  
node: In the Eastern European country of Sokovia, the Avengers—Tony Stark, Thor, Bruce Banner, Steve Rogers, Natasha Romanoff, and Clint Barton—raid a Hydra facility commanded by Baron Wolfgang von Strucker, who has experimented on humans using the scepter previously wielded by Loki.  They meet two of Strucker's test subjects—twins Pietro (who has superhuman speed) and Wanda Maximoff (who has telepathic and telekinetic abilities)—and apprehend Strucker, while Stark retrieves Loki's scepter.  
Stark and Banner discover an artificial intelligence within the scepter's gem, and secretly decide to use it to complete Stark's &quot;Ultron&quot; global defense program.  The unexpectedly sentient Ultron, believing he must eradicate humanity to save Earth, eliminates Stark's A.I.  
</code></pre>
<p>从结果中我们可以看出，原来的retreiver
模块输出的只是简单的一句话，而meta_replacer
模块输出的是多个句子，包含了检索节点的前后节点的文本，这样可以让 LLM 生成更准确的答案。</p>
<p>关于句子窗口检索的更多细节，可以参考我之前的<a href="http://mp.weixin.qq.com/s?__biz=Mzg5NDkxMzQwMA==&amp;mid=2247484078&amp;idx=1&amp;sn=d2cc9d1170ddcc5dd3310480a9628aa7&amp;chksm=c0191cb9f76e95af339d4d48f00e3b8daa91159d8c91d801e2d82c64bd537b586c272222757f&amp;scene=21#wechat_redirect">这篇文章</a>。</p>
<h4 id="增加评估模块">增加评估模块</h4>
<p>最后我们再为查询流水线增加一个评估模块，用于评估查询流水线，这里我们使用Ragas[6]来实现评估模块。</p>
<blockquote>
<p>Ragas 是一个评估 RAG 应用的框架，拥有很多且详细的评估指标。</p>
</blockquote>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/adswRFDIWz0yt8hpZYRE2yMvDX5VKicdHCbTpyfNNb5MPicmOkP5pxjrv9deUVSaZ4w7AUKIfEao8xtdNricxLFow/640?wx_fmt=png" alt=""></p>
<pre><code>+evaluator = RagasComponent()  
p = QueryPipeline(verbose=True)  
p.add_modules(  
    {  
        &quot;input&quot;: InputComponent(),  
        &quot;query_rewriter&quot;: query_rewriter,  
        &quot;retriever&quot;: retriever,  
        &quot;meta_replacer&quot;: meta_replacer,  
        &quot;reranker&quot;: reranker,  
        &quot;output&quot;: TreeSummarize(),  
+        &quot;evaluator&quot;: evaluator,  
    }  
)  
-p.add_link(&quot;input&quot;, &quot;query_rewriter&quot;)  
+p.add_link(&quot;input&quot;, &quot;query_rewriter&quot;, src_key=&quot;input&quot;)  
p.add_link(&quot;query_rewriter&quot;, &quot;retriever&quot;)  
p.add_link(&quot;retriever&quot;, &quot;meta_replacer&quot;)  
-p.add_link(&quot;input&quot;, &quot;reranker&quot;, dest_key=&quot;query_str&quot;)  
+p.add_link(&quot;input&quot;, &quot;reranker&quot;, src_key=&quot;input&quot;, dest_key=&quot;query_str&quot;)  
p.add_link(&quot;meta_replacer&quot;, &quot;reranker&quot;, dest_key=&quot;nodes&quot;)  
-p.add_link(&quot;input&quot;, &quot;output&quot;, dest_key=&quot;query_str&quot;)  
+p.add_link(&quot;input&quot;, &quot;output&quot;, src_key=&quot;input&quot;, dest_key=&quot;query_str&quot;)  
p.add_link(&quot;reranker&quot;, &quot;output&quot;, dest_key=&quot;nodes&quot;)  
+p.add_link(&quot;input&quot;, &quot;evaluator&quot;, src_key=&quot;input&quot;, dest_key=&quot;question&quot;)  
+p.add_link(&quot;input&quot;, &quot;evaluator&quot;, src_key=&quot;ground_truth&quot;, dest_key=&quot;ground_truth&quot;)  
+p.add_link(&quot;reranker&quot;, &quot;evaluator&quot;, dest_key=&quot;nodes&quot;)  
+p.add_link(&quot;output&quot;, &quot;evaluator&quot;, dest_key=&quot;answer&quot;)  
</code></pre>
<ul>
<li>
<p>RagasComponent
也是一个自定义的查询流水线组件，后面我们再详细介绍它的实现</p>
</li>
<li>
<p>在查询流水线中增加了一个evaluator
模块，用于评估查询流水线</p>
</li>
<li>
<p>我们将evaluator
模块放到output模块之后，用于评估输出结果</p>
</li>
<li>
<p>evaluator
模块有 4 个输入参数，分别是问题、真实答案、检索结果和生成答案，其中问题和真实答案通过input
模块传入，检索结果通过reranker
模块传入，生成答案通过output
模块传入</p>
</li>
<li>
<p>因为input
模块现在有 2 个参数，分别是问题input
和真实答案ground_truth
，所以我们在添加input
模块的相关连接关系时，需要指定src_key
参数</p>
</li>
</ul>
<p>我们再来看下RagasComponent
的实现，示例代码如下：</p>
<pre><code>from ragas.metrics import faithfulness, answer_relevancy, context_precision, context_recall  
from ragas import evaluate  
from datasets import Dataset  
from llama_index.core.query_pipeline import CustomQueryComponent  
from typing import Dict, Any  
  
metrics = [faithfulness, answer_relevancy, context_precision, context_recall]  
  
class RagasComponent(CustomQueryComponent):  
    &quot;&quot;&quot;Ragas evalution component.&quot;&quot;&quot;  
  
    def _validate_component_inputs(self, input: Dict[str, Any]) -&gt; Dict[str, Any]:  
        &quot;&quot;&quot;Validate component inputs during run_component.&quot;&quot;&quot;  
        return input  
  
    @property  
    def _input_keys(self) -&gt; set:  
        &quot;&quot;&quot;Input keys dict.&quot;&quot;&quot;  
        return {&quot;question&quot;, &quot;nodes&quot;, &quot;answer&quot;, &quot;ground_truth&quot;, }  
  
    @property  
    def _output_keys(self) -&gt; set:  
        return {&quot;answer&quot;, &quot;source_nodes&quot;, &quot;evaluation&quot;}  
  
    def _run_component(self,**kwargs) -&gt; Dict[str, Any]:  
        &quot;&quot;&quot;Run the component.&quot;&quot;&quot;  
        question, ground_truth, nodes, answer = kwargs.values()  
        data = {  
            &quot;question&quot;: [question],  
            &quot;contexts&quot;: [[n.get_content() for n in nodes]],  
            &quot;answer&quot;: [str(answer)],  
            &quot;ground_truth&quot;: [ground_truth],  
        }  
        dataset = Dataset.from_dict(data)  
        evalution = evaluate(dataset, metrics)  
        return {&quot;answer&quot;: str(answer), &quot;source_nodes&quot;: nodes, &quot;evaluation&quot;: evalution}  
</code></pre>
<ul>
<li>
<p>和之前的自定义组件一样，RagasComponent
类需要实现_validate_component_inputs
、_input_keys
、_output_keys
和_run_component
方法</p>
</li>
<li>
<p>组件的输入参数是问题、真实答案、检索结果和生成答案，输出参数是生成答案、检索结果和评估结果</p>
</li>
<li>
<p>在_run_component
方法中，我们将输入参数重新封装成一个可供 Ragas 评估的Dataset
对象</p>
</li>
<li>
<p>评估指标我们使用的分别是：faithfulness
（评估Question
和Context
的一致性），answer_relevancy
（评估Answer
和Question
的一致性），context_precision
（评估Ground Truth
在Context
中是否排名靠前），context_recall
（评估Ground Truth
和Context
的一致性）</p>
</li>
<li>
<p>我们再调用evaluate
方法对Dataset
对象进行评估，得到评估结果</p>
</li>
<li>
<p>最后将生成答案、检索结果和评估结果一起返回</p>
</li>
</ul>
<p>最后我们来运行下查询流水线，示例代码如下：</p>
<pre><code>question = &quot;Which two members of the Avengers created Ultron?&quot;  
ground_truth = &quot;Tony Stark (Iron Man) and Bruce Banner (The Hulk).&quot;  
output = p.run(input=question, ground_truth=ground_truth)  
print(f&quot;answer: {output['answer']}&quot;)  
print(f&quot;evaluation: {output['evaluation']}&quot;)  
  
# 显示结果  
answer: Tony Stark and Bruce Banner  
evaluation: {'faithfulness': 1.0000, 'answer_relevancy': 0.8793, 'context_precision': 1.0000, 'context_recall': 1.0000}  
</code></pre>
<ul>
<li>
<p>运行查询流水线时，我们需要传入问题和真实答案作为输入参数</p>
</li>
<li>
<p>在输出结果中，我们可以看到生成的答案，以及评估结果 4 个评估指标的值</p>
</li>
</ul>
<p>关于 RAG 的更多评估工具，可以参考我之前的<a href="http://mp.weixin.qq.com/s?__biz=Mzg5NDkxMzQwMA==&amp;mid=2247484144&amp;idx=1&amp;sn=d9271ba3ecc0ebce2f205aa511a52ebb&amp;chksm=c0191ce7f76e95f18436f6a5b2a6caf01b5ded6af59334e10c4abbc1063bb19ee217cfd00abd&amp;scene=21#wechat_redirect">这篇文章</a>。</p>
<h4 id="总结">总结</h4>
<p>通过上面的示例，我们可以看到如何通过模块化和流程的方式来实现高级 RAG 检索功能，我们可以根据具体的需求，自定义不同的模块，然后将这些模块按照一定的顺序组合起来，形成一个完整的查询流水线。在 RAG 应用中，我们还可以定义多个查询流水线，用于不同的场景，比如问答、对话、推荐等，这样可以更好地满足不同的需求。</p>
<p>关注我，一起学习各种人工智能和 AIGC 新技术，欢迎交流，如果你有什么想问想说的，欢迎在评论区留言。</p>
<h4 id="引用参考">引用参考</h4>
<ul>
<li>
<p>Modular RAG and RAG Flow: Part Ⅰ[8]   * Modular RAG and RAG Flow: Part II[9]</p>
</li>
<li>
<p>An Introduction to LlamaIndex Query Pipelines[10] #### 参考:</p>
</li>
</ul>
<p>[1]</p>
<p>LlamaIndex: <em><a href="https://www.llamaindex.ai/">https://www.llamaindex.ai/</a></em></p>
<p>[2]</p>
<p>复仇者联盟: <em><a href="https://en.wikipedia.org/wiki/Avenger">https://en.wikipedia.org/wiki/Avenger</a></em></p>
<p>[3]</p>
<p>Cohere: <em><a href="https://cohere.com/">https://cohere.com/</a></em></p>
<p>[6]</p>
<p>Ragas: <em><a href="https://docs.ragas.io/">https://docs.ragas.io/</a></em></p>
<p>[8]</p>
<p>Modular RAG and RAG Flow: Part Ⅰ: <em><a href="https://medium.com/@yufan1602/modular-rag-and-rag-flow-part-%E2%85%B0-e69b32dc13a3">https://medium.com/@yufan1602/modular-rag-and-rag-flow-part-%E2%85%B0-e69b32dc13a3</a></em></p>
<p>[9]</p>
<p>Modular RAG and RAG Flow: Part II: <em><a href="https://medium.com/@yufan1602/modular-rag-and-rag-flow-part-ii-77b62bf8a5d3">https://medium.com/@yufan1602/modular-rag-and-rag-flow-part-ii-77b62bf8a5d3</a></em></p>
<p>[10]</p>
<p>An Introduction to LlamaIndex Query Pipelines: <em><a href="https://docs.llamaindex.ai/en/stable/examples/pipeline/query_pipeline/">https://docs.llamaindex.ai/en/stable/examples/pipeline/query_pipeline/</a></em></p>
<p>更多AI工具，参考<a href="https://ai123.869hr.uk/">Github-AI123</a>，<a href="https://ai123.869hr.uk/">国内AI123</a></p>



          </div>

 可扫如下微信二维码加好友

<p><img src="/images/aitools/2024/03/qrcode_for_gh_dde1b429630d_258.jpg" alt=""></p>

        </article>

      </div>
    </div>
  </div>
</section>
        </div>
    </div>
    </main>




<script type='text/javascript' src='/assets/js/jquery.ui.touch-punch.min-0.2.2.js' id='jqueryui-touch-js'></script>
<script type='text/javascript' src='/assets/js/clipboard.min-5.6.2.js' id='clipboard-js'></script>
<script type='text/javascript' src='/assets/js/tooltip-extend.js' id='iplaycode-nav-js'></script>
<script type='text/javascript' id='popper-js-extra'>
 

var theme = {"ajaxurl":"","addico":"https:\/\/nav.baidu.cn\/wp-content\/themes\/onenav\/images\/add.png","order":"asc","formpostion":"top","defaultclass":"io-grey-mode","isCustomize":"1","icourl":"","icopng":".png","urlformat":"1","customizemax":"10","newWindow":"0","lazyload":"1","minNav":"1","loading":"1","hotWords":"baidu","classColumns":" col-sm-6 col-md-4 col-xl-5a col-xxl-6a ","apikey":"TWpBeU1UVTNOekk1TWpVMEIvZ1M2bFVIQllUMmxsV1dZelkxQTVPVzB3UW04eldGQmxhM3BNWW14bVNtWk4="};
 
</script>
<script type='text/javascript' src='/assets/js/popper.min.js' id='popper-js'></script>
<script type='text/javascript' src='/assets/js/bootstrap.min-4.3.1.js' id='bootstrap-js'></script>
<script type='text/javascript' src='/assets/js/theia-sticky-sidebar-1.5.0.js' id='sidebar-js'></script>
<script type='text/javascript' src='/assets/js/lazyload.min-12.4.0.js' id='lazyload-js'></script>
<script type='text/javascript' src='/assets/js/fancybox.min-3.5.7.js' id='lightbox-js-js'></script>

<script type='text/javascript' src='/assets/js/app-anim.js' id='appanim-js'></script>

<script type="text/javascript">
    $(document).ready(function(){
        var siteWelcome = $('#loading');
        siteWelcome.addClass('close');
        setTimeout(function() {
            siteWelcome.remove();
        }, 600);
    });
</script>
<script>        
    $(document).ready(function(){
        setTimeout(function () {
            if ($('a.smooth[href="' + window.location.hash + '"]')[0]) {
                $('a.smooth[href="' + window.location.hash + '"]').click();
            }else if (window.location.hash != '') {
                $("html, body").animate({
                    scrollTop: $(window.location.hash).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
        }, 300);
        $(document).on('click','a.smooth',function(ev) {
            if($('#sidebar').hasClass('show') && !$(this).hasClass('change-href')){
                $('#sidebar').modal('toggle');
            }
            if($(this).attr("href").substr(0, 1) == "#"){
                $("html, body").animate({
                    scrollTop: $($(this).attr("href")).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
            if($(this).hasClass('go-search-btn')){
                $('#search-text').focus();
            }
            if(!$(this).hasClass('change-href')){
                var menu =  $("a"+$(this).attr("href"));
                menu.click();
                toTarget(menu.parent().parent(),true,true);
            }
        });
        $(document).on('click','a.tab-noajax',function(ev) {
            var url = $(this).data('link');
            if(url)
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').show().attr('href', url);
            else
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').hide();
        });
        
    });
</script>

<script>

(function(){
    if(document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") === ''){
        if(new Date().getHours() > 22 || new Date().getHours() < 6){
            document.body.classList.remove('io-black-mode');
            document.body.classList.add('io-grey-mode');
            document.cookie = "night=1;path=/";
            console.log('夜间模式开启');
        }else{
            document.body.classList.remove('night');
            document.cookie = "night=0;path=/";
            console.log('夜间模式关闭');
        }
    }else{
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
        if(night == '0'){
            document.body.classList.remove('night');
        }else if(night == '1'){
            document.body.classList.add('night');
        }
    }
})();

$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");   
function switchNightMode(){
    var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
    if(night == '0'){
	$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");
        document.body.classList.remove('io-grey-mode');
        document.body.classList.add('io-black-mode');
        document.cookie = "night=1;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","日间模式");
        $(".mode-ico").removeClass("icon-night");
        $(".mode-ico").addClass("icon-light");
    }else{
	$("#search-bg").css("background", "linear-gradient(#4f4040, #1b1d1f)");
        document.body.classList.remove('io-black-mode');
        document.body.classList.add('io-grey-mode');
        document.cookie = "night=0;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","夜间模式");
        $(".mode-ico").removeClass("icon-light");
        $(".mode-ico").addClass("icon-night");
    }
}
</script>


<script>
    var newsContainer = document.getElementById('news-container');
    var newsItems = document.getElementsByClassName('news-item');
    var currentItem = 0;

    setInterval(function() {
        
        newsItems[currentItem].classList.remove('show');
        newsItems[currentItem].style.transform = 'translateY(-20px)';
        
        currentItem = (currentItem + 1) % newsItems.length;
        newsItems[currentItem].style.transform = 'translateY(' + (newsContainer.offsetHeight - 20) + 'px)';
        setTimeout(function() {
            newsItems[currentItem].classList.add('show');
        }, 500);
    }, 8000);
</script>

</body>
</html>


