

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#f9f9f9" />

	<title>OpenAI科学家Karpathy周末造出「婴儿Llama2」！GPT-4辅助写500行纯C代码，速揽16k星 作者： 新智元 来源： 新智元 ** ** **新智元报道 ** 编辑：桃子 好困 【新智元导读】 OpenAI科学家Karpathy用了一个周末时间打造出明星项目llama2.c。他借助GPT-4辅助，仅用500行C语言代码实现对Llama 2 baby模型的推理。 你有  | AI123| ai工具网址导航,ai最新产品</title>
	<link rel="shortcut icon" href="/assets/images/favicon.png" />
    <meta name="keywords" content="chatgpt,AI,AI聊天,AI文本生成,AI绘画,AI编程,AI电商" />
    <meta name="description" content="AI123 网址导航 | 免费chatgpt 汇集各类先进的人工智能产品，旨在帮助用户更快速地了解和使用这些产品,轻松地浏览不同领域的AI产品，包括语音识别、图像处理、自然语言处理。" />
    
    <meta name="baidu-site-verification" content="codeva-cCAOSG8MBO" />
    
    <link rel="stylesheet" id="block-library-css"
        href="/assets/css/block-library.min-5.6.2.css" type="text/css" media="all" />
    <link rel="stylesheet" id="iconfont-css" href="/assets/css/iconfont-3.03029.1.css"
        type="text/css" media="all" />

    
    <link href="/scss/style.min.css" rel="stylesheet" />
    
		    <link rel="stylesheet" id="iowen-css" href="/assets/css/style-3.03029.1.css"
        type="text/css" media="all" />
    <link rel="stylesheet" id="custom-css" href="/assets/css/custom-style.css"
        type="text/css" media="all" />
		
		<link rel="stylesheet" href=/plugins/font-awesome/css/font-awesome.min.css />


    <link rel="stylesheet" id="fortawesome-css" href="/assets/fontawesome-5.15.4/css/all.min.css" type="text/css" />


    <script type="text/javascript" src="/assets/js/jquery.min-3.2.1.js" id="jquery-js"></script>
    <script type="text/javascript" src="/assets/js/content-search.js"  id="content-search-js"></script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2073588164294660"
     crossorigin="anonymous"></script>

	
    <script>
        

		var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?8450bc732b2a86f7e4aec4ebd9fd8252";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();

        
    </script>
    

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7071W80M2K"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-7071W80M2K');
    </script>

</head>


    <div class="page-container">
	
	<div id="sidebar" class="sticky sidebar-nav fade animate-nav" style="width: 170px">
        
            <div class="modal-dialog h-100 sidebar-nav-inner">
                <div class="sidebar-logo border-bottom border-color">
                    
                    <div class="logo overflow-hidden">
                        <a href="https://ai123.869hr.uk/" class="logo-expanded">
                            <img src="/assets/images/bt8-expand-light.png" height="40" class="logo-light"
                                alt="AI123| ai工具网址导航,ai最新产品">
                            <img src="/assets/images/bt8-expand-dark.png" height="40" class="logo-dark d-none"
                                alt="AI123| ai工具网址导航,ai最新产品">
                        </a>
                        <a href="https://ai123.869hr.uk/" class="logo-collapsed">
                            <img src="/assets/images/bt.png" height="40" class="logo-light"
                                alt="AI123| ai工具网址导航,ai最新产品">
                            <img src="/assets/images/bt.png" height="40" class="logo-dark d-none"
                                alt="AI123| ai工具网址导航,ai最新产品">
                        </a>
                    </div>
                    
                </div>
                <div class="sidebar-menu flex-fill">
                    <div class="sidebar-scroll">
                        <div class="sidebar-menu-inner">
                            <ul>
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#00834a9dd147b04c5d53d4368cdb0b57" class="smooth">
                                            <i class="fas fa-sun fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>本月热门</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db0311e7ecfedd24d157f0ceb4a0897f" class="smooth">
                                            <i class="fas fa-star-and-crescent fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>热门网站</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#21b5cbb2c769010fec3ce029a5f8a4a3" class="smooth">
                                            <i class="far fa-star fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>国内热门</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#8310718935e8ec25ce0350de01e3f7dc" class="smooth">
                                            <i class="fas fa-phone fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>对话工具</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#d58e850d9115797306c2edf61ac6ddd8" class="smooth">
                                            <i class="fas fa-newspaper fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>写作</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2a7418a5f8f1ca4e054364a9300657df" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>图像生成</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#7808a68ee1b34dab43011429a12de19e" class="smooth">
                                            <i class="fas fa-image fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>图像处理</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#6729afc51f5ac49a828812fa0eb0c82f" class="smooth">
                                            <i class="fas fa-video fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>音视频</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#e5ce844860451fff3faf3d8f8894971d" class="smooth">
                                            <i class="fas fa-music fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>音乐生成</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#db53804b7d726967c58fcc8c9ca03d27" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>办公</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#47b7af9547e034d28fe6f6d439968ac8" class="smooth">
                                            <i class="fas fa-copy fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>提示词</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#41282bf95e43c64d579757573a03cdde" class="smooth">
                                            <i class="fas fa-code fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>编程</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#fd71852fd52d5e18ef4f9a252f1eac58" class="smooth">
                                            <i class="fas fa-search fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>AI搜索</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#81b1637fbe47625dbdf2094acd3b6683" class="smooth">
                                            <i class="fas fa-language fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>文本翻译</span>
                                        </a>
                                    </li>
                                    
                                
                                    
                                    <li class="sidebar-item">
                                        <a href="/#2e9ba3fa6e1ed0e9311b3e97f97f9a40" class="smooth">
                                            <i class="fas fa-book fa-lg fa-lg icon-fw icon-lg mr-2"></i>
                                            <span>学习网站</span>
                                        </a>
                                    </li>
                                    
                                
                            </ul>           
                        </div>
                    </div>
                </div>
                <div class="border-top py-2 border-color">
                    <div class="flex-bottom">
                        <ul>
			    <li id="menu-item-212"
                                 class="menu-item menu-item-type-custom menu-item-object-custom menu-item-212 sidebar-item">
                                 <a href="#friendlink" class="smooth">
                                     <i class="fab fa-staylinked icon-fw icon-lg mr-2"></i>
                                     <span>友情链接</span>
                                 </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div class="flex-fill grid-bg">
    <div class="big-header-banner">
        <div id="header" class="page-header sticky">
            <div class="navbar navbar-expand-md">
                <div class="container-fluid p-0">

                    <a href="" class="navbar-brand d-md-none" title="AI123| ai工具网址导航,ai最新产品">
                        <img src="/assets/images/bt.png" class="logo-light"
                            alt="AI123| ai工具网址导航,ai最新产品">
                        <img src="/assets/images/bt.png" class="logo-dark d-none"
                            alt="AI123| ai工具网址导航,ai最新产品">
                    </a>

                    <div class="collapse navbar-collapse order-2 order-md-1">
                        <div class="header-mini-btn">
                            <label>
                                <input id="mini-button" type="checkbox">
                                <svg viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                    <path class="line--1" d="M0 40h62c18 0 18-20-17 5L31 55"></path>
                                    <path class="line--2" d="M0 50h80"></path>
                                    <path class="line--3" d="M0 60h62c18 0 18 20-17-5L31 45"></path>
                                </svg>
                            </label>

                        </div>

                        <ul class="navbar-nav site-menu" style="margin-right: 16px;">
                        
			<li >
				<a href="/">
                                    <i class="fa fa-home fa-lg mr-2"></i>
                                    <span>首页</span>
                                </a>
				<ul class="sub-menu">
				
				</ul>
			    </li>
			
			</ul>

                        
                        <div class="rounded-circle weather">
                            <div id="he-plugin-simple" style="display: contents;"></div>
                            <script>WIDGET = {
                                    CONFIG: {
                                        "modules": "01234",
                                        "background": 5,
                                        "tmpColor": "008000",
                                        "tmpSize": 14,
                                        "cityColor": "008000",
                                        "citySize": 14,
                                        "aqiColor": "#008000",
                                        "aqiSize": 14,
                                        "weatherIconSize": 24,
                                        "alertIconSize": 18,
                                        "padding": "10px 10px 10px 10px",
                                        "shadow": "1",
                                        "language": "auto",
                                        "borderRadius": 5,
                                        "fixed": "false",
                                        "vertical": "middle",
                                        "horizontal": "left",
                                        "key": "085791e805a24491b43b06cf58ab31e7"
                                    }
                                }
                            </script>
                            <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script>
                        </div>
                        
                    </div>

                    <ul class="nav navbar-menu text-xs order-1 order-md-2">
                        
                        
                        <li class="nav-item mr-3 mr-lg-0 d-none d-lg-block">
                            <script>
                                fetch('https://v1.hitokoto.cn')
                                    .then(response => response.json())
                                    .then(data => {
                                    const hitokoto = document.getElementById('hitokoto_text')
                                    hitokoto.href = 'https://hitokoto.cn/?uuid=' + data.uuid
                                    hitokoto.innerText = data.hitokoto
                                    })
                                    .catch(console.error)
                            </script>                           
                            <div id="hitokoto"><a href="#" target="_blank" id="hitokoto_text">疏影横斜水清浅，暗香浮动月黄昏。</a></div>
                        </li>
                        
                        
                        <li class="nav-search ml-3 ml-md-4">
                            <a href="javascript:" data-toggle="modal" data-target="#search-modal"><i
                                    class="iconfont icon-search icon-2x"></i></a>
                        </li>
                        <li class="nav-item d-md-none mobile-menu ml-3 ml-md-4">
                            <a href="javascript:" id="sidebar-switch" data-toggle="modal"
                                data-target="#sidebar"><i class="iconfont icon-classification icon-2x"></i></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="placeholder" style="height:74px"></div>
    </div>




<body class="page-body boxed-container  io-grey-mode">
    <main role="main" class="flex-shrink-0">
    <div class="container">
        
        <div class="content">
            <style>
    body{
	    background: #f9f9f9;
	}

    h1, h2, h3, h4, h5, h6 {
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
    }


 
@media (min-width: 1000px) {
  .container, .container-sm {
    max-width: 800px;
  }
}

</style>

<div class="featured-post-content">

    <a href="/digest/" class="featured-post-title">
       AI 文摘
    </a>

</div>

<section class="blog-single">
  <div class="container">
    <div class="row">

      <div class="col-lg-12 order-1 order-lg-2">
        <article class="single-blog">
          <p class="title">OpenAI科学家Karpathy周末造出「婴儿Llama2」！GPT-4辅助写500行纯C代码，速揽16k星</p>
            <br/>
          <ul class="meta">
            <li>
              By <a href=https://ai123.869hr.uk/about>AI123</a>
            </li>
            <li>
              <i class="fa fa-clock-o"></i>
              July 25, 2023 - 2 min read
            </li>
          </ul>

          <div class="_1NCGf">
              <img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8weWeQAkIskutsscQMAhN1FFD4fg5GLsyjjMticLuSvwoU5Hw3Q7LYV6icA/640?wx_fmt=png" width="640" >
          </div>
            <br>
            <br>
            <br>
          
          <div class="single-blog-content">
            <p>作者： 新智元  来源： <a href="https://mp.weixin.qq.com/s/lmB74YRP7dTHe_GfaIpOMg">新智元</a></p>
<h4 id="httpsapialloriginswinrawurlhttpsmmbizqpiccnsz_mmbiz_jpguicq7hgwiaub1jzpwf5k1kxmw3chnqk8wejsqkibb7ekdx99xvjia5nhln1uo0nh5dq3f9yeoqnniczi1llgo9a60va640wx_fmtjpeg"><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_jpg/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8wejsqKibb7eKDx99xvJia5nHLn1uo0nH5DQ3F9yEoQNniczI1LlGO9A60VA/640?wx_fmt=jpeg" alt=""></h4>
<h4 id="heading"></h4>
<h4 id="heading-1"></h4>
<p>** ** **新智元报道 **</p>
<p>编辑：桃子 好困</p>
<h4 id="新智元导读-openai科学家karpathy用了一个周末时间打造出明星项目llama2c他借助gpt-4辅助仅用500行c语言代码实现对llama-2-baby模型的推理"><strong>【新智元导读】</strong> OpenAI科学家Karpathy用了一个周末时间打造出明星项目llama2.c。他借助GPT-4辅助，仅用500行C语言代码实现对Llama 2 baby模型的推理。</h4>
<p>你有没有想过仅用C语言去推理一个Llama 2的baby模型？</p>
<p>没有？现在就能做到了！</p>
<p>就在刚刚过去的这个周末，OpenAI科学家Andrej Karpathy做了一个非常有趣的项目——llama2.c。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8weX2kTmLxiahRJtiabrxTiaxSSAx2kvONxDT1M4zp2LLSOgfU0tibuHCSiazw/640?wx_fmt=png" alt=""></p>
<p>项目灵感正是来自于之前的明星项目——llama.cpp</p>
<p>首先，在PyTorch中训练一个较小的Llama 2模型。</p>
<p>然后，用500行代码在纯C环境下进行推理，并且无需任何依赖项。</p>
<p>最后得到的预训练模型（基于TinyStories），可以在MacBook Air M1 CPU上用fp32以每秒18个token的速度生成故事样本。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8weefEQfYdo95VbjhO7cJ7jHkoJrvyBaTufwDr0PGIR29sxFUDw1ImwqQ/640?wx_fmt=png" alt=""></p>
<p>llama2.c一经发布，就在GitHub上速揽1.6k星，并且还在快速攀升中。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8wekiaQoDBH84u34FyHYFlBBf5Miccopr6L9raJRiaFSfplRx2kbzxia19RYQ/640?wx_fmt=png" alt=""></p>
<p>项目地址：https://github.com/karpathy/llama2.c</p>
<p>顺便，Karpathy还表示：「感谢GPT-4对我生疏的C语言提供帮助！」</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8weicK5kUuNEic18OFPqs4ibicw8uma9Cia9safOWBllCqYs4oghogVyr6riavw/640?wx_fmt=png" alt=""></p>
<p>英伟达科学家Jim Fan称，GPT-4帮助Karpathy用C语言「养」了一只baby Llama！太了不起了！</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8wen3qMdRgiba7Cfx3AkaIR2dozbeOslK1WzWiaiabmUMweg9MDm4iaZ6BicIQ/640?wx_fmt=png" alt=""></p>
<p>网友也表示，使用GPT-4构建llama2.c，堪称是终极跨界。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8wezynzCHpTprWbxymwzhnjjVNPhiauSYHrSD5InbqIRaicfgZVia4xowWgA/640?wx_fmt=png" alt=""></p>
<p>纯C语言推理Llama 2</p>
<h4 id="heading-2"></h4>
<p>可能Karpathy没想到，这个llama2.c项目的潜力是如此巨大。</p>
<blockquote>
<p>令人惊讶的是，你可以在单线程的CPU上以fp32的交互速率对这些较小（O(~10MB)）的模型进行推理。</p>
<p>不过，我还没尝试过使用最小的Meta LLama2检查点（7B），预计速度会很慢。</p>
</blockquote>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8wegmV17JKrwGSh6d98K0QdqEFyCzCJ3m75LWvcOjhb8QLzof7slzs0sg/640?wx_fmt=png" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8wemJ5AfzBnHCGVUMrYfohiaz1RFCRyDYqxkrg1SGDwz3eXdJlKCOUcHUQ/640?wx_fmt=png" alt=""></p>
<p>Karpathy表示，在较窄的领域（比如，故事）中，人们可以使用更小的Transformer来做有趣的事情。</p>
<p>因此，这个简单的纯C语言实现还是很实用的，尤其是它还可以进行移植。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8weJdjvpXEbv0ibkk29h0nZvgFystlgiab9WazMS2EENuvnRY202CI89YEg/640?wx_fmt=png" alt=""></p>
<p>紧接着，他又使用-O3编译，将MacBook Air M1上的每秒处理token数tok/s从18增加到了98。</p>
<p>对于使用这样简单的方法，并能够以较高的交互速率运行相当大小的模型（几千万参数），Karpathy表示非常幸兴奋——</p>
<p>「看来，我现在必须训练一个更大的模型了。」</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8weWeQAkIskutsscQMAhN1FFD4fg5GLsyjjMticLuSvwoU5Hw3Q7LYV6icA/640?wx_fmt=png" alt=""></p>
<blockquote>
<p>事实证明，我原来的检查点用编译-O3在MacBook Air M1上运行_way_（100 tok/s）的速度比我预期的要快，所以我现在正在训练一个更大的44M模型，它应该仍然以交互方式运行。也许7B Llama模型触手可及。</p>
</blockquote>
<p>代码开源</p>
<h4 id="heading-3"></h4>
<p>目前，llama2.c的代码已经开源。</p>
<p>利用这段代码，你可以在PyTorch中从头开始训练Llama 2 LLM架构，然后将权重保存为原始二进制文件，并加载到一个约500行C文件（run. c）中。目前，该文件使用fp32对模型进行推理。</p>
<p>在云Linux开发环境中，Karpathy用一个维度为288、6层、6头的模型（约1500万参数）在fp32下以约100 tok/s的速度进行推理，而这也与M1 MacBook Air上的运行情况大致相同。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8weJoLdSYSV5rYg63ypM2BOPok0Gg23HVH4tLML0P8zERJGSv9w5Zkic6A/640?wx_fmt=png" alt=""></p>
<h4 id="感受魔力"><strong>感受魔力</strong></h4>
<p>在C中运行一个baby Llama 2模型前，首先需要一个模型检查点。</p>
<p>对此，你可以下载在TinyStories数据集上训练的这个15M参数模型（约58MB），并将其放入默认检查点目录out： <br>
*</p>
<pre><code>wget https://karpathy.ai/llama2c/model.bin -P out
</code></pre>
<p>然后，编译并运行C代码： <br>
*   *</p>
<pre><code>gcc -O3 -o run run.c -lm
./run out/model.bin
</code></pre>
<p>可以看到，这只是对原始token进行了流式处理。想要读取的话，就需要将其转换为文本。</p>
<p>遗憾的是，现在只能通过一个简单的Python函数装饰器来实现翻译（30行代码）： <br>
*   *</p>
<pre><code>pip install sentencepiece
python run_wrap.py
</code></pre>
<p>在M1 MacBook Air上，它的运行速度约为每秒100个token，对于超级简单的fp32单线程C代码来说，效果还不错。</p>
<p>示例输出：</p>
<blockquote>
<p>Once upon a time, there was a boy named Timmy. Timmy loved to play sports with his friends. He was very good at throwing and catching balls. One day, Timmy&rsquo;s mom gave him a new shirt to wear to a party. Timmy thought it was impressive and asked his mom to explain what a shirt could be for. &ldquo;A shirt is like a special suit for a basketball game,&rdquo; his mom said. Timmy was happy to hear that and put on his new shirt. He felt like a soldier going to the army and shouting. From that day on, Timmy wore his new shirt every time he played sports with his friends at the party. Once upon a time, there was a little girl named Lily. She loved to play outside with her friends. One day, Lily and her friend Emma were playing with a ball. Emma threw the ball too hard and it hit Lily&rsquo;s face. Lily felt embarrassed and didn&rsquo;t want to play anymore. Emma asked Lily what was wrong, and Lily told her about her memory. Emma told Lily that she was embarrassed because she had thrown the ball too hard. Lily felt bad achieved tok/s: 98.746993347843922</p>
</blockquote>
<p>从前，有一个叫Timmy的男孩。Timmy喜欢和他的朋友们一起运动。他非常擅长扔球和接球。一天，Timmy的妈妈给了他一件新衬衫，让他穿去参加一个聚会。Timmy觉得这件衬衫很棒，便问妈妈它有没有什么特别的用途。「衬衫就像篮球比赛时的特殊套装，」他妈妈说。Timmy听了很高兴，于是穿上了这件新衬衫。他感觉自己像个士兵要去参军一样，大声呐喊。从那天起，每次在聚会上和朋友们一起运动时，Timmy都会穿着这件新衬衫。从前，有一个叫Lily的小女孩。她喜欢和她的朋友在外面玩。一天，Lily和她的朋友Emma正在玩球。Emma把球扔得太用力了，结果打到了Lily的脸上。Lily觉得很尴尬，不想再玩了。Emma问Lily怎么了，Lily告诉她她的记忆。Emma告诉Lily，她很尴尬，因为她把球扔得太用力了。Lily觉得很糟糕。Tok/s：98.746993347843922</p>
<h4 id="使用指南"><strong>使用指南</strong></h4>
<p>理论上应该可以加载Meta发布的权重，但即使是最小的7B模型，使用这个简单的单线程C程序来进行推理，速度估计快不了。</p>
<p>所以在这个repo中，我们专注于更窄的应用领域，并从头开始训练相同的架构。</p>
<p>首先，下载并预分词一些源数据集，例如TinyStories： <br>
*   *</p>
<pre><code>python tinystories.py download
python tinystories.py pretokenize
</code></pre>
<p>然后，训练模型： <br>
*</p>
<pre><code>python train.py
</code></pre>
<p>更多特殊启动和超参数覆盖的信息，请查看train.py脚本。Karpathy预计简单的超参数探索应该可以得到更好的模型，因此并没有对其进行调整。</p>
<p>如果想跳过模型训练，只需下载Karpathy的预训练模型并将其保存到out目录中，就可以进行简单的演示了： <br>
*</p>
<pre><code>wget https://karpathy.ai/llama2c/model.bin -P out
</code></pre>
<p>一旦有了model.bin文件，就可以在C中进行推理。</p>
<p>首先，编译C代码： <br>
*</p>
<pre><code>gcc -O3 -o run run.c -lm
</code></pre>
<p>然后，运行： <br>
*</p>
<pre><code>./run out/model.bin
</code></pre>
<p>注意，这里输出的只是SentencePiece token。要将token解码为文本，还需利用一个简单的装饰器来运行这个脚本： <br>
*</p>
<pre><code>python run_wrap.py
</code></pre>
<p>此外，也可以运行PyTorch推理脚本进行比较（将model.ckpt添加到/out目录中）： <br>
*</p>
<pre><code>python sample.py
</code></pre>
<p>这将得到相同的结果。更详细的测试将在test_all.py中进行，运行方式如下： <br>
*</p>
<pre><code>$ pytest
</code></pre>
<p>目前，你需要两个文件来进行测试或采样：model.bin文件和之前进行PyTorch训练的model.ckpt文件。</p>
<p>（论如何在不下载200MB数据的情况下运行测试。）</p>
<h4 id="待办事项"><strong>待办事项</strong></h4>
<ul>
<li>
<p>为什么SentencePiece无法正确地迭代解码？</p>
</li>
<li>
<p>希望能够删除run_wrap.py文件，直接使用C代码转换为字符串</p>
</li>
</ul>
<p>-是否支持多查询的功能？对于在CPU上运行的较小模型似乎用处不大？</p>
<ul>
<li>
<p>计划支持超过max_seq_len步数的推理，必须考虑kv缓存的情况</p>
</li>
<li>
<p>为什么在我的A100 40GB GPU上进行训练时，MFU如此之低（只有约10%）？</p>
</li>
<li>
<p>使用DDP时出现了torch.compile和wandb的奇怪错误</p>
</li>
<li>
<p>增加更好的测试来减少yolo</p>
</li>
</ul>
<p>网友热议</p>
<h4 id="heading-4"></h4>
<p>借着llama2.c热乎劲儿，网友将llama2编译成Emscripten，并在网页上运行。</p>
<p>他使用Emscripten进行了编译，并修改了代码，以在每次渲染时预测一个token。网页自动加载了50MB的模型数据。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8we5hutzP7AQaun3NCBqbSqHkicXUCGpBUtvlmEV6rVLIrRuBzrsZx3fwQ/640?wx_fmt=png" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_gif/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8wejLlMHrTGp1NCFwCOC2mSsS7pXZJdxjTJ4icQyb9T0I7qkQnpNXpehvQ/640?wx_fmt=gif" alt=""></p>
<p>此外，他还增添了去token化的支持。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8weh5SH2N7Lg1rpJfic3XRjWojv2cvCiaBVwKWvrCdH3KoWkJ2DyWO5GIkw/640?wx_fmt=png" alt=""></p>
<p>还有网友表示，基于llama.cpp的成功，这个行业似乎正朝着为每个发布的模型提供单独源代码的方向发展，而不是像pytorch/tenorflow/onnxruntime这样的通用框架？</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8wevKhnOsIcfqDaNyZdzlNy0USUHkGgQ9pYia53I7qtXniaZicDicuwhD8r7g/640?wx_fmt=png" alt=""></p>
<p>llama2.c的意义在何处？</p>
<p>网友举了一个生动的例子，创建一个关于一个有100人的小岛的电脑游戏，每个人都有意识，llama2. c是他们的大脑。然后你可以模拟一千年的历史，看看会发生什么。</p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_png/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8wevcR7iakGDFKIOQibQoxDYNZAX0RY5A6MZ7HQMARVg3aedt1JKonw88cg/640?wx_fmt=png" alt=""></p>
<p>参考资料：</p>
<p><a href="https://github.com/karpathy/llama2.c">https://github.com/karpathy/llama2.c</a></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/sz_mmbiz_jpg/UicQ7HgWiaUb1JzpWf5k1KxmW3cHNQk8wehRYJvbjFTQlQerycMCZa7819iaTbiciaRRvXOIH0Uib4aNIxIUmQfQljHg/640?wx_fmt=jpeg" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_jpg/UicQ7HgWiaUb1lKYCMMiaxGxWTbkaPTAxuR84iaPsp8u8Yg0okpLUj3ibsPkwdQXjibPcp8oW1jmJAmZmMEia2sjDKpGA/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt=""></p>
<p><img src="https://api.allorigins.win/raw?url=https://mmbiz.qpic.cn/mmbiz_gif/UicQ7HgWiaUb10PoMc8QQNrjsp8lOMiaPwVkHbjVicxntJynwdmjiadosl2znIvDTSjWsp4kcqlbqVdFt6TxqpptrkA/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" alt=""></p>
<p>更多AI工具，参考<a href="https://ai123.869hr.uk/">Github-AI123</a>，<a href="https://ai123.869hr.uk/">国内AI123</a></p>



          </div>

可关注我们的公众号：每天AI新工具

<p><img src="/images/aitools/2024/03/qrcode_for_gh_dde1b429630d_258.jpg" alt=""></p>

        </article>

      </div>
    </div>
  </div>
</section>
        </div>
    </div>
    </main>




<script type='text/javascript' src='/assets/js/jquery.ui.touch-punch.min-0.2.2.js' id='jqueryui-touch-js'></script>
<script type='text/javascript' src='/assets/js/clipboard.min-5.6.2.js' id='clipboard-js'></script>
<script type='text/javascript' src='/assets/js/tooltip-extend.js' id='iplaycode-nav-js'></script>
<script type='text/javascript' id='popper-js-extra'>
 

var theme = {"ajaxurl":"","addico":"https:\/\/nav.baidu.cn\/wp-content\/themes\/onenav\/images\/add.png","order":"asc","formpostion":"top","defaultclass":"io-grey-mode","isCustomize":"1","icourl":"","icopng":".png","urlformat":"1","customizemax":"10","newWindow":"0","lazyload":"1","minNav":"1","loading":"1","hotWords":"baidu","classColumns":" col-sm-6 col-md-4 col-xl-5a col-xxl-6a ","apikey":"TWpBeU1UVTNOekk1TWpVMEIvZ1M2bFVIQllUMmxsV1dZelkxQTVPVzB3UW04eldGQmxhM3BNWW14bVNtWk4="};
 
</script>
<script type='text/javascript' src='/assets/js/popper.min.js' id='popper-js'></script>
<script type='text/javascript' src='/assets/js/bootstrap.min-4.3.1.js' id='bootstrap-js'></script>
<script type='text/javascript' src='/assets/js/theia-sticky-sidebar-1.5.0.js' id='sidebar-js'></script>
<script type='text/javascript' src='/assets/js/lazyload.min-12.4.0.js' id='lazyload-js'></script>
<script type='text/javascript' src='/assets/js/fancybox.min-3.5.7.js' id='lightbox-js-js'></script>

<script type='text/javascript' src='/assets/js/app-anim.js' id='appanim-js'></script>

<script type="text/javascript">
    $(document).ready(function(){
        var siteWelcome = $('#loading');
        siteWelcome.addClass('close');
        setTimeout(function() {
            siteWelcome.remove();
        }, 600);
    });
</script>
<script>        
    $(document).ready(function(){
        setTimeout(function () {
            if ($('a.smooth[href="' + window.location.hash + '"]')[0]) {
                $('a.smooth[href="' + window.location.hash + '"]').click();
            }else if (window.location.hash != '') {
                $("html, body").animate({
                    scrollTop: $(window.location.hash).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
        }, 300);
        $(document).on('click','a.smooth',function(ev) {
            if($('#sidebar').hasClass('show') && !$(this).hasClass('change-href')){
                $('#sidebar').modal('toggle');
            }
            if($(this).attr("href").substr(0, 1) == "#"){
                $("html, body").animate({
                    scrollTop: $($(this).attr("href")).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
            if($(this).hasClass('go-search-btn')){
                $('#search-text').focus();
            }
            if(!$(this).hasClass('change-href')){
                var menu =  $("a"+$(this).attr("href"));
                menu.click();
                toTarget(menu.parent().parent(),true,true);
            }
        });
        $(document).on('click','a.tab-noajax',function(ev) {
            var url = $(this).data('link');
            if(url)
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').show().attr('href', url);
            else
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').hide();
        });
        
    });
</script>

<script>

(function(){
    if(document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") === ''){
        if(new Date().getHours() > 22 || new Date().getHours() < 6){
            document.body.classList.remove('io-black-mode');
            document.body.classList.add('io-grey-mode');
            document.cookie = "night=1;path=/";
            console.log('夜间模式开启');
        }else{
            document.body.classList.remove('night');
            document.cookie = "night=0;path=/";
            console.log('夜间模式关闭');
        }
    }else{
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
        if(night == '0'){
            document.body.classList.remove('night');
        }else if(night == '1'){
            document.body.classList.add('night');
        }
    }
})();

$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");   
function switchNightMode(){
    var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
    if(night == '0'){
	$("#search-bg").css("background", "linear-gradient(#e2c4c4, #d8d8d8)");
        document.body.classList.remove('io-grey-mode');
        document.body.classList.add('io-black-mode');
        document.cookie = "night=1;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","日间模式");
        $(".mode-ico").removeClass("icon-night");
        $(".mode-ico").addClass("icon-light");
    }else{
	$("#search-bg").css("background", "linear-gradient(#4f4040, #1b1d1f)");
        document.body.classList.remove('io-black-mode');
        document.body.classList.add('io-grey-mode');
        document.cookie = "night=0;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","夜间模式");
        $(".mode-ico").removeClass("icon-light");
        $(".mode-ico").addClass("icon-night");
    }
}
</script>


<script>
    var newsContainer = document.getElementById('news-container');
    var newsItems = document.getElementsByClassName('news-item');
    var currentItem = 0;

    setInterval(function() {
        
        newsItems[currentItem].classList.remove('show');
        newsItems[currentItem].style.transform = 'translateY(-20px)';
        
        currentItem = (currentItem + 1) % newsItems.length;
        newsItems[currentItem].style.transform = 'translateY(' + (newsContainer.offsetHeight - 20) + 'px)';
        setTimeout(function() {
            newsItems[currentItem].classList.add('show');
        }, 500);
    }, 8000);
</script>

</body>
</html>


